<dom-module id="geomap-element">
  <style>
    google-map {
      height: 900px;
    }
  </style>
  <template>
    <geo-location watch-pos latitude="{{lat}}" longitude="{{lng}}"></geo-location>
    <google-map id="map" latitude="[[lat]]" longitude="[[lng]]">
      <google-map-marker icon="../../images/map.png" latitude="[[lat]]" longitude="[[lng]]"></google-map-marker>
    </google-map>
    <iron-ajax
      auto
      contentType="application/x-www-form-urlencoded"
      url="/controllers/callApi.php"
      method="POST"
      body="lat={{lat}}&lng={{lng}}"
      on-response="handleResponse"
      last-response="{{ajaxResponse}}"
      debounce-duration="300"></iron-ajax>
  </template>
      
  <script>
  Polymer({
    is: "geomap-element",
    handleResponse: function(event,data) {
      if(this.ajaxResponse) {
        for(var i=0; i<this.ajaxResponse.length; i++) {
          var obj = this.ajaxResponse[i];
          var dynamicEl = document.createElement("google-map-marker");
          dynamicEl.setAttribute("latitude", obj.lat);
          dynamicEl.setAttribute("longitude", obj.lon);
          dynamicEl.setAttribute("icon","../../images/car223.png");
          Polymer.dom(this.$.map).appendChild(dynamicEl);
        } 
      }
    },
    ready: function () {
      var loc = document.querySelector('geo-location');
      loc.addEventListener('geo-response', function(e) {
        console.log('lat:' + this.latitude, 'lng:' + this.longitude);
        this.lat=this.latitude;
        this.lng=this.lng;
      });
    }
  });
  </script>
</dom-module>